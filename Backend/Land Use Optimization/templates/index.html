<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Farm Analysis & Crop Recommendation Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .flash { color: red; }
  </style>
  <!-- Include Leaflet and Leaflet.draw CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
</head>
<body>
  <h1>Farm Analysis & Crop Recommendation Tool</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul>
      {% for category, message in messages %}
         <li class="flash">{{ message }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  {% if not location %}
    <form method="post" action="/">
      <label for="place">Enter a location:</label>
      <input type="text" name="place" id="place" required>
      <button type="submit">Search</button>
    </form>
  {% else %}
    <p><strong>Found location:</strong> {{ location.address }}</p>
    <p>Zoom in for better clarity and use the drawing tool below to mark your farm boundary.</p>

    <!-- Display the Folium map -->
    <div id="map">
      {{ map_html|safe }}
    </div>

    <!-- Hidden form to capture the drawn polygon and other details -->
    <form method="post" action="{{ url_for('recommend') }}" id="recommendForm">
      <input type="hidden" name="polygon_geojson" id="polygon_geojson">
      <input type="hidden" name="address" value="{{ location.address }}">
      <input type="hidden" name="lat" value="{{ location.latitude }}">
      <input type="hidden" name="lon" value="{{ location.longitude }}">
      <button type="submit">Get Crop Recommendation</button>
    </form>
  {% endif %}

  <script>
    // Once the page loads, try to access the Leaflet map created by Folium.
    document.addEventListener("DOMContentLoaded", function() {
      // Folium renders the map with an element whose id starts with "map_"
      var mapElement = document.querySelector('[id^="map_"]');
      if(mapElement && mapElement._leaflet_map) {
          var map = mapElement._leaflet_map;
          // Create a FeatureGroup to store drawn items.
          var drawnItems = new L.FeatureGroup();
          map.addLayer(drawnItems);
          // Add the Leaflet Draw control.
          var drawControl = new L.Control.Draw({
              edit: { featureGroup: drawnItems },
              draw: {
                  polyline: false,
                  rectangle: false,
                  circle: false,
                  marker: false,
                  circlemarker: false,
                  polygon: true
              }
          });
          map.addControl(drawControl);

          // When a new shape is created, add it to the drawnItems group and update the hidden input.
          map.on('draw:created', function (e) {
              var layer = e.layer;
              drawnItems.addLayer(layer);
              var geojson = layer.toGeoJSON();
              document.getElementById('polygon_geojson').value = JSON.stringify(geojson.geometry);
          });

          // Update the hidden input if shapes are edited.
          map.on('draw:edited', function(e) {
              e.layers.eachLayer(function(layer) {
                  var geojson = layer.toGeoJSON();
                  document.getElementById('polygon_geojson').value = JSON.stringify(geojson.geometry);
              });
          });
      }
    });
  </script>
</body>
</html>
